apiVersion: apps/v1
kind: Deployment
metadata:
  name: sqmgr-dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sqmgr-dev
  template:
    metadata:
      labels:
        app: sqmgr-dev
    spec:
      initContainers:
        - name: liquibase
          image: weters/sqmgr-lb
          imagePullPolicy: Always
          envFrom:
            - secretRef:
                name: sqmgr-config
          args:
            - '--url'
            - 'jdbc:postgresql://$(PG_HOST):$(PG_PORT)/$(PG_DBNAME)'
            - '--username'
            - '$(PG_USER)'
            - '--password'
            - '$(PG_PASSWORD)'
            - '--changeLogFile'
            - './sql/migrations.sql'
            - 'update'
      containers:
      - name: sqmgr
        envFrom:
          - secretRef:
              name: sqmgr-config
        env:
        - name: SQMGR_CONF_SMTP
          value: 10.1.1.1:25
        - name: SQMGR_CONF_FROM_ADDRESS
          value: no-reply@sqmgr.com
        - name: SQMGR_CONF_URL
          value: https://sqmgr.com
        - name: SQMGR_CONF_DSN
          value: 'dbname=$(PG_DBNAME) host=$(PG_HOST) port=$(PG_PORT) user=$(PG_USER) sslmode=$(PG_SSLMODE) password=$(PG_PASSWORD)'
        - name: SQMGR_CONF_JWT_PUBLIC_KEY
          value: /opt/sqmgr/jwt-keys/public.pem
        - name: SQMGR_CONF_JWT_PRIVATE_KEY
          value: /opt/sqmgr/jwt-keys/private.pem
        image: weters/sqmgrserver:latest
        imagePullPolicy: Always
        volumeMounts:
          - mountPath: /opt/sqmgr/jwt-keys
            name: jwt-keys
      volumes:
        - name: jwt-keys
          secret:
            secretName: sqmgr-jwt-keys
      imagePullSecrets:
      - name: docker-hub
